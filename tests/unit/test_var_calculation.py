import math

import numpy as np
from numpy.ma.testutils import assert_equal

from src.var_calculation import calculate_1d_shift, calculate_pnl_vector_1d, calculate_historical_var_1d, \
    calculate_parametric_var_1d, calculate_total_var_1d

historical_total_pnl_values: np.ndarray = np.array([566.0460208,
                                                    86.13994553,
                                                    533.8462689,
                                                    801.5138829,
                                                    153.7043188,
                                                    -382.2420697,
                                                    163.925025,
                                                    -9.059470454,
                                                    -170.320806,
                                                    -662.1164278,
                                                    406.4874153,
                                                    450.1407946,
                                                    30.56539561,
                                                    70.38844461,
                                                    81.23450407,
                                                    -296.3563708,
                                                    277.4396293,
                                                    -675.0933225,
                                                    784.2020908,
                                                    -61.94811335,
                                                    -60.95346815,
                                                    -99.11878729,
                                                    1758.941271,
                                                    -623.1978701,
                                                    4829.659315,
                                                    845.3487031,
                                                    -351.7565713,
                                                    -843.4997413,
                                                    140.5217505,
                                                    -1326.831978,
                                                    682.1052496,
                                                    865.2356945,
                                                    -1164.04424,
                                                    -174.2487879,
                                                    -37.57758647,
                                                    -160.4486332,
                                                    234.6943986,
                                                    -532.6295289,
                                                    373.6441644,
                                                    876.3877182,
                                                    -255.8757003,
                                                    -271.5811573,
                                                    -134.4053491,
                                                    322.9749865,
                                                    -36.0847507,
                                                    62.57347319,
                                                    431.6844543,
                                                    302.4856955,
                                                    383.9711466,
                                                    -399.4093885,
                                                    1846.354316,
                                                    656.5184253,
                                                    413.1142104,
                                                    -496.3118794,
                                                    606.1429215,
                                                    -294.5714019,
                                                    13812.31702,
                                                    -12647.62776,
                                                    -974.3752905,
                                                    -279.2714375,
                                                    1458.50765,
                                                    -547.3118685,
                                                    287.8522861,
                                                    -129.6283857,
                                                    344.4492225,
                                                    1032.986499,
                                                    883.1609749,
                                                    484.5253402,
                                                    -8.801996796,
                                                    -738.3891919,
                                                    -104.088924,
                                                    -567.7845812,
                                                    476.405359,
                                                    -654.3087343,
                                                    -729.5668145,
                                                    100.8363173,
                                                    213.0898075,
                                                    -1249.745443,
                                                    -1899.684474,
                                                    -1577.52995,
                                                    -273.3732101,
                                                    745.6441843,
                                                    710.6850915,
                                                    215.8360323,
                                                    123.1143822,
                                                    982.336442,
                                                    224.4833228,
                                                    -619.9321189,
                                                    -617.0465949,
                                                    329.0119811,
                                                    -146.6660024,
                                                    89.21078471,
                                                    -800.1770443,
                                                    -107.2252429,
                                                    -150.0589587,
                                                    123.5395086,
                                                    -272.7138229,
                                                    -534.5807,
                                                    731.7118754,
                                                    -252.5693969,
                                                    134.1073819,
                                                    -60.93477975,
                                                    112.4803648,
                                                    -760.9722152,
                                                    -297.4539055,
                                                    197.1174294,
                                                    651.8910635,
                                                    275.2484364,
                                                    -622.5812832,
                                                    -790.3465213,
                                                    193.5114146,
                                                    71.72555969,
                                                    -17.53590725,
                                                    -559.4843789,
                                                    -446.7849409,
                                                    -549.36145,
                                                    217.22368,
                                                    179.5951653,
                                                    508.3609101,
                                                    -938.7339524,
                                                    -246.2332558,
                                                    -47.69033913,
                                                    130.2575154,
                                                    188.2553015,
                                                    -230.0133474,
                                                    288.5905384,
                                                    -1122.597368,
                                                    49.08178152,
                                                    -61.18782409,
                                                    -721.2511713,
                                                    -619.4405306,
                                                    -516.9624972,
                                                    -239.0259393,
                                                    -758.1627274,
                                                    -102.8268658,
                                                    358.4136232,
                                                    -919.1166323,
                                                    -556.7041554,
                                                    -666.3292011,
                                                    816.8483467,
                                                    355.8017832,
                                                    825.2484032,
                                                    766.2254184,
                                                    -40169.92782,
                                                    598.8724611,
                                                    54968.27624,
                                                    135.7661228,
                                                    163.6230383,
                                                    -384.4105092,
                                                    -517.0516538,
                                                    -72.56533589,
                                                    -83.36194136,
                                                    -946.188805,
                                                    473.488207,
                                                    287.9812317,
                                                    -66.50327678,
                                                    1350.624458,
                                                    -213.9663385,
                                                    -133.0184615,
                                                    -1003.085642,
                                                    -613.331197,
                                                    530.2531083,
                                                    -1086.114798,
                                                    295.8631454,
                                                    378.2242362,
                                                    -1519.09001,
                                                    75.04415617,
                                                    683.1450195,
                                                    -406.7876781,
                                                    2820.233504,
                                                    -1478.681964,
                                                    -869.1018775,
                                                    58.97212295,
                                                    -825.0557939,
                                                    -396.6247409,
                                                    748.6860189,
                                                    1055.967341,
                                                    -1263.913688,
                                                    998.7584259,
                                                    -1076.401826,
                                                    475.4999504,
                                                    341.6656877,
                                                    -412.7389681,
                                                    -439.56718,
                                                    -492.7797459,
                                                    -444.4744592,
                                                    1531.102025,
                                                    1808.542615,
                                                    306.7862971,
                                                    -126.0040009,
                                                    48.59873854,
                                                    312.1726423,
                                                    621.3149582,
                                                    11.53799719,
                                                    662.0838275,
                                                    -1163.776536,
                                                    119.6464405,
                                                    -165.2162275,
                                                    -201.282093,
                                                    -66.88273097,
                                                    688.0767034,
                                                    698.2322908,
                                                    -1581.80086,
                                                    223.4674382,
                                                    -274.6210646,
                                                    -353.6373535,
                                                    -1159.9923,
                                                    -333.6505433,
                                                    -60.26784765,
                                                    1037.750303,
                                                    59.56255093,
                                                    1078.309562,
                                                    685.4639981,
                                                    -467.2611909,
                                                    447.6288257,
                                                    1231.688422,
                                                    499.792971,
                                                    -393.2084166,
                                                    1251.660558,
                                                    1131.657303,
                                                    -173.0842892,
                                                    -902.8830575,
                                                    -381.1705713,
                                                    -256.0323095,
                                                    1092.178184,
                                                    -563.4435587,
                                                    -1240.972581,
                                                    1145.795413,
                                                    455.4278055,
                                                    -80.65840958,
                                                    -509.873453,
                                                    648.8338527,
                                                    174.029715,
                                                    196.0968238,
                                                    -379.324021,
                                                    158.750191,
                                                    -46.68868923,
                                                    57.47332941,
                                                    -103.6708023,
                                                    1588.73697,
                                                    854.0368593,
                                                    -2485.242961,
                                                    -507.4068165,
                                                    -124.6966627,
                                                    159.5684725,
                                                    -304.5868413,
                                                    24.11125352,
                                                    243.5647464,
                                                    -1106.03574,
                                                    585.725884,
                                                    -211.3800812,
                                                    165.5562236,
                                                    -644.4144989,
                                                    907.7246736,
                                                    -1321.514632,
                                                    -14960.39284,
                                                    17525.44653,
                                                    -968.3059692,
                                                    -1575.238131])


def test_1d_shift():
    # Given
    previous_day_market_rate: float = 1.1684427
    current_day_market_rate: float = 1.165976797

    # When
    result: float = calculate_1d_shift(previous_day_market_rate, current_day_market_rate)

    # Then
    expected_result: float = math.exp(math.log(previous_day_market_rate / current_day_market_rate)) - 1
    assert_equal(result, expected_result)


def test_pnl_vector_1d():
    # Given
    one_day_shift: float = 0.002115
    portfolio_value: float = 153084.81

    # When
    result: float = calculate_pnl_vector_1d(one_day_shift, portfolio_value)

    # Then
    expected_result: float = one_day_shift * portfolio_value
    assert_equal(result, expected_result)


def test_historical_var_1d():
    # Given
    confidence_level: float = 0.99

    # When
    result: float = calculate_historical_var_1d(historical_total_pnl_values, confidence_level)

    # Then
    expected_result: float = round(
        float(np.percentile(historical_total_pnl_values, (1 - confidence_level) * 100)),
        2
    )
    assert_equal(result, expected_result)


def test_calculate_parametric_var_1d():
    # Given
    confidence_level: float = 0.99
    z_value = -2.33

    # When
    result: float = calculate_parametric_var_1d(historical_total_pnl_values, confidence_level)

    # Then
    expected_result: float = float(
        round(
            np.std(historical_total_pnl_values, ddof=1) * round(z_value, 2),
            2
        ))
    assert_equal(result, expected_result)


def test_calculate_total_var_1d():
    # Given

    # When
    result: float = calculate_total_var_1d(historical_total_pnl_values)

    # Then
    expected_result: float = round(
        0.4 * float(sorted(historical_total_pnl_values)[1]) + 0.6 * float(sorted(historical_total_pnl_values)[2]),
        2
    )
    assert_equal(result, expected_result)
